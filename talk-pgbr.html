<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=1024, user=scalable=no"/><link rel="stylesheet" href="deck.js/core/deck.core.css"/><link rel="stylesheet" href="deck.js/extensions/goto/deck.goto.css"/><link rel="stylesheet" href="deck.js/extensions/menu/deck.menu.css"/><link rel="stylesheet" href="deck.js/extensions/navigation/deck.navigation.css"/><link rel="stylesheet" href="deck.js/extensions/status/deck.status.css"/><link rel="stylesheet" href="deck.js/extensions/scale/deck.scale.css"/><link rel="stylesheet" id="style-theme-link" href="deck.js/themes/style/neon.css"/><link rel="stylesheet" id="transition-theme-link" href="deck.js/themes/transition/fade.css"/><link rel="stylesheet" href="talk.css"/><script src="deck.js/modernizr.custom.js"></script><script src="deck.js/jquery-1.6.4.min.js"></script><script src="scripts/jquery.snippet.min.js"></script><link rel="stylesheet" href="scripts/jquery.snippet.min.css"/></head><script>$(document).ready(function(){
    $('pre.sql').snippet('sql',{style:'pablo',showNum:true, menu:true})
})
</script><body class="deck-container"><!-- begin talk -->
<section class="slide"><h1 style="font-size:2.5em"># \dfS pg_*: Um passeio pelas funções administrativas do PostgreSQL</h1></section><section class="slide"><h2>Características do catálogo</h2><ol><li class="slide"><h3>Armazena metadados da instância</h3><p>Extenso conjunto de informações distribuídas em tabelas e views de sistema<ul><li>Definição de objetos (tabelas, atributos, índices, tipos, &c)</li><li>Estatísticas do banco de dados</li></ul></p></li><li class="slide"><h3>Organizado e padronizado</h3><p>Convenção de nomes simples e consistente</p><table class="info"><tr><th>sufixo</th><th>descrição</th></tr><tr><td>pg_</td><td>objeto de catálogo (reservado apenas para <em>schema</em>)</td></tr><tr><td>stat_</td><td>Informação de estatística</td></tr><tr><td>io_</td><td>eventos de E/S</td></tr><tr><td>ts_</td><td>configurações de FTS</td></tr></table><ul><li>Ex.: <em>pg_catalog,  pg_stat_activity,  pg_statio_user</em></li></ul></li></ol></section><section class="slide"><h2>Características do catálogo (cont.)</h2><ol><li class="slide"><h3>Compreensível</h3><p>Dicionário de simples entendimento e manipulação</p></li><li class="slide"><h3>Extensível</h3><p>Com pouco esforço é possível adicionar novas funcionalidades (funções, operadores, &c)</p></li><li class="slide"><h3>Completo</h3><p>Além do acesso aos metadados, permite analisar arquivos de dados</p></li></ol></section><section class="slide"><h2>Informações sobre o catálogo</h2><ol><li class="slide"><h3>2331 funções de sistema</h3></li><li class="slide"><h3>86 funções estatísticas</h3></li><li class="slide"><h3>36 views administrativas</h3></li><li class="slide"><h3>48 tabelas de sistema</h3></li><li class="slide"><h3>71 objetos no <em>information_schema</em> (ISO/IEC 9075-11:2008)</h3></li></ol></section><section class="slide"><h2>Sobre o nome da palestra</h2><ol><pre class="sql">SELECT routine_schema, routine_name, data_type 
  FROM information_schema.routines

</pre><p>OU</p><pre>postgres=# \dfS+
</pre><pre>  Schema   |         Name               |     Result data type     |
-----------+----------------------------+--------------------------|
pg_catalog | pg_database_size           | bigint                   |
pg_catalog | pg_database_size           | bigint                   |
pg_catalog | pg_describe_object         | text                     |
pg_catalog | pg_encoding_max_length     | integer                  |
pg_catalog | pg_encoding_to_char        | name                     |
pg_catalog | pg_extension_config_dump   | void                     |
pg_catalog | pg_function_is_visible     | boolean                  |
</pre></ol></section><section class="slide"><h2>Tipos de fun&ccedil;&otilde;es</h2><ol><li class="slide"><h3>Funções administrativas</h3><p>- Obter informações de objetos do banco de dados através do catálogo</p></li><li class="slide"><h3>Funções estatísticas</h3><p>- Monitorar estatísticas de atividade do servidor</p></li><li class="slide"><h3>Funções WAL</h3><p>- Manipular e obter informações do log de transações (<em>aka</em> WAL)</p></li></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Ex.: obtendo informações de um arquivo</h3><pre class="sql">SELECT current_setting('config_file');
</pre><pre>           current_setting                
----------------------------------------------
 /Library/PostgreSQL/8.4/data/postgresql.conf
</pre><pre class="sql">SELECT now() - modification AS &quot;última modificação&quot;
  FROM pg_stat_file(current_setting('config_file'));

</pre><pre>-[ RECORD 1 ]------+-----------------------
última modificação | 5 days 17:18:21.507422
</pre></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Ex.: Tempo de vida do servidor</h3><pre class="sql">SELECT format('%s, up %s, %s users, cache hit ratio: %% %s',
   LOCALTIME, (CURRENT_DATE - date_trunc('days', pg_postmaster_start_time())),
   pg_stat_get_db_numbackends(oid),
   round(( pg_stat_get_db_blocks_hit(oid)::float 
        / (pg_stat_get_db_blocks_fetched(oid)
         + pg_stat_get_blocks_hit(oid) + 1) * 100)::numeric,2)) AS &quot;uptime&quot;
 FROM pg_catalog.pg_database
WHERE datname = current_database();
</pre><pre>-[ RECORD 1 ]--------------------------------------------------
uptime | 17:42:52, up 8 days, 2 users, cache hit ratio: % 81.61
</pre></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Parece, mas não é...</h3><pre class="sql">SELECT pg_relation_size('foobar') AS falso, 
       pg_table_size('foobar') AS verdadeiro;

</pre><pre>+--------+------------+
| falso  | verdadeiro |
+--------+------------+
| 368640 |     393216 |
+--------+------------+
</pre></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Parece, mas não é...</h3><pre class="sql">SELECT pg_relation_size('foobar','fsm' /* ou vm */)
       ,pg_total_relation_size('foobar');

</pre><pre>+------------------+------------------------+
| pg_relation_size | pg_total_relation_size |
+------------------+------------------------+
|            24576 |                 393216 |
+------------------+------------------------+
</pre></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Outras funções administrativas<table class="info"><tr><td><em>função</em></td><td><em>resultado</em></td></tr><tr><td>SELECT pg_database_size('postgres')</td><td>6759224</td></tr><tr><td>SELECT pg_indexes_size('foobar')</td><td>245760</td></tr><tr><td>SELECT pg_size_pretty('100024')</td><td>98 kB  </td></tr><tr><td>SELECT pg_relation_filepath('foobar')</td><td>base/12180/16393</td></tr></table></h3></ol></section><section class="slide"><h2>Funções administrativas - <em>WAL</em></h2><ol><h3>Ex.: Obtendo o registro atual do XLOG</h3><pre class="sql">SELECT pg_current_xlog_insert_location();
</pre><pre>pg_current_xlog_insert_location 
---------------------------------
0/11570578
</pre></ol></section><section class="slide"><h2>Funções administrativas - <em>WAL</em></h2><ol><h3>Obtendo <em>offset</em> do registro atual do XLOG</h3><pre class="sql">SELECT CAST(X'570578' AS INTEGER) /* x = 010101110000010101111000 */
    AS file_offset;

</pre><p>OU</p><pre class="sql">SELECT file_name, file_offset 
  FROM pg_xlogfile_name_offset(pg_current_xlog_location());

</pre><pre>+--------------------------+-------------+
|        file_name         | file_offset |
+--------------------------+-------------+
| 000000010000000000000011 |    5703032  |
+--------------------------+-------------+
</pre></ol></section><section class="slide"><h2>Funções administrativas - <em>WAL</em></h2><ol><li class="slide"><h3>Ex.: Obtendo informações do LOG</h3><pre class="sql">WITH RECURSIVE xlog(i,c) AS  
(VALUES (0,pg_current_xlog_location())
  UNION ALL 
SELECT generate_series(1,
    (((pg_xlogfile_name_offset(
            pg_current_xlog_location())).file_offset / 16777216.) * 100
    )::int), NULL
)
</pre></li></ol></section><section class="slide"><h2>Funções administrativas - <em>WAL</em></h2><ol><li class="slide"><h3>Ex.: Obtendo informações XLOG (cont)</h3><pre class="sql">SELECT rpad(array_to_string(array_agg(
        regexp_replace(i::varchar,'\d{1,3}',U&amp;'\2593') 
        ),'',''),100,U&amp;'\2591')
AS &quot;Gráfico de ocupação do XLOG&quot;
FROM xlog
</pre><pre>+----------------------------------------------------------------------------+
|                       Gráfico de ocupação do XLOG                          |
+----------------------------------------------------------------------------+
| ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  |
+----------------------------------------------------------------------------+
</pre></li></ol></section><section class="slide"><h2>Funções administrativas</h2><ol><h3>Outras funções do WAL<table class="info"><tr><td><em>função</em></td><td><em>resultado</em></td></tr><tr><td>SELECT pg_switch_xlog()</td><td>0/F47DFF8</td></tr><tr><td>SELECT pg_create_restore_point(CURRENT_DATE::text);</td><td>0/10000110</td></tr><tr><td>SELECT pg_xlog_replay_pause()</td><td>void</td></tr><tr><td>SELECT pg_xlog_replay_resume()</td><td>void</td></tr></table></h3></ol></section><section class="slide"><h2>Funções de estatísticas</h2><ol><li class="slide"><h3>Ex.: Obtendo informações E/S</h3><pre class="sql">SELECT round(( pg_stat_get_db_blocks_hit(oid)::float
/ (pg_stat_get_db_blocks_fetched(oid)
+ pg_stat_get_blocks_hit(oid) + 1) * 100)::numeric,2) AS &quot;hit ratio&quot;
FROM pg_catalog.pg_database;
</pre><pre>+-----------+-----------+
|  datname  | hit ratio |
+-----------+-----------+
| postgres  |     96.67 |
+-----------+-----------+

</pre></li></ol></section><section class="slide"><h2>Funções estatísticas</h2><ol><h3>Ex.: Obtendo informações de um <em>backend</em>:</h3><pre class="sql">SELECT usesysid, application_name, backend_start, waiting 
  FROM pg_stat_get_activity(pg_backend_pid())

</pre><pre>+----------+------------------+-------------------------------+---------+
| usesysid | application_name |         backend_start         | waiting |
+----------+------------------+-------------------------------+---------+
|       10 | psql             | 2011-11-03 12:14:25.966554-02 | f       |
+----------+------------------+-------------------------------+---------+

</pre></ol></section><section class="slide"><h2>Funções estatísticas</h2><ol><h3>Outras funções de estatísticas<table class="info"><tr><td><em>função</em></td><td><em>resultado</em></td></tr><tr><td>SELECT pg_stat_get_bgwriter_requested_checkpoints();</td><td>36</td></tr><tr><td>SELECT pg_stat_get_buf_written_backend();</td><td>6</td></tr><tr><td>SELECT pg_stat_get_backend_waiting(1023);</td><td>false</td></tr></table></h3></ol></section><section class="slide"><h2>Referências</h2><ol><li><h3>http://www.postgresql.org</h3></li><li><h3>http://www.postgresql.org/docs/9.1/interactive/functions-admin.html</h3></li><li><h3>http://www.postgresql.org/docs/9.1/interactive/monitoring-stats.html</h3></li></ol></section><section class="slide"><h1 style="font-size:2.5em">SELECT pg_terminate_backend(pg_backend_pid());
</h1></section><!-- end talk -->
<p class="deck-status"><span class="deck-status-current"></span>/
<span class="deck-status-total"></span></p><footer>Leonardo Cezar - Confer&ecirc;ncia Brasileira de PostgreSQL</footer><form action="." method="get" class="goto-form"><label for="goto-slide">Slide:<input id="goto-slide" type="number" name="slidenum"/><input type="submit" value="transportar"/></label></form></body><script src="deck.js/core/deck.core.js"></script><script src="deck.js/extensions/goto/deck.goto.js"></script><script src="deck.js/extensions/menu/deck.menu.js"></script><script src="deck.js/extensions/navigation/deck.navigation.js"></script><script src="deck.js/extensions/status/deck.status.js"></script><script src="deck.js/extensions/scale/deck.scale.js"></script><script>$(function(){
    $.deck('.slide')
})
</script></html>